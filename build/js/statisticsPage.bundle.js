(()=>{"use strict";let e=[],t=null,a=null,n=[],r=[],o=null,s=null,l=[],c=[],i=null,u=[],d=[],m=document.querySelector(".main-date__value"),p=(new Date).getFullYear()+"-"+("0"+(+(new Date).getMonth()+1)).slice(-2);var h;localStorage.getItem("currentDate")||localStorage.setItem("currentDate",p),m.textContent=(h=localStorage.getItem("currentDate"))?"Все время"==h?h:7==h.length?new Date(h).toLocaleString("default",{month:"long"})+" "+new Date(h).getFullYear():4==h.length?h:void 0:(new Date).toLocaleString("default",{month:"long"})+" "+(new Date).getFullYear();let g=localStorage.getItem("email").replace(".","*"),y=document.querySelector(".balance-dynamics-chart__date-wrapper");y.textContent=(new Date).toLocaleString("ru",{year:"numeric",month:"numeric",day:"numeric"}).split(".").reverse().join("-");let f={};!function(){var e=am5.Root.new("trend-chart");e.setThemes([am5themes_Animated.new(e)]);var t=e.container.children.push(am5xy.XYChart.new(e,{panX:!0,wheelX:"panX",wheelY:"zoomX",pinchZoomX:!0,paddingLeft:0,layout:e.verticalLayout}));t.set("cursor",am5xy.XYCursor.new(e,{behavior:"none"})).lineY.set("visible",!1),t.zoomOutButton.set("forceHidden",!0);var a=am5xy.AxisRendererX.new(e,{pan:"zoom",minGridDistance:10}),n=t.xAxes.push(am5xy.CategoryAxis.new(e,{maxDeviation:.1,categoryField:"date",start:.5,minZoomCount:1,maxZoomCount:6,renderer:a}));n.get("renderer").labels.template.setAll({oversizedBehavior:"wrap",textAlign:"center"}),a.labels.template.setAll({fontSize:"0.8em"});var r=t.yAxes.push(am5xy.ValueAxis.new(e,{renderer:am5xy.AxisRendererY.new(e,{strokeOpacity:.1})})),o=t.series.push(am5xy.ColumnSeries.new(e,{name:"месяцы",xAxis:n,yAxis:r,valueYField:"cost",categoryXField:"date",fill:"rgb(0,128,0)"}));o.columns.template.setAll({tooltipText:"{categoryX}: {valueY}",width:am5.percent(90),tooltipY:0,strokeOpacity:0}),o.columns.template.setAll({templateField:"bg"}),o.bullets.push((function(){return am5.Bullet.new(e,{locationY:1,sprite:am5.Label.new(e,{text:"{valueY}",templateField:"bulletLocation",fill:"black",centerX:am5.percent(50),populateText:!0})})})),f={chart:t,series:o,xAxis:n,yAxis:r}}();let x={};function _(e,t,a,n){var r,o,s=function(e){const t=e.reduce(((e,t)=>{const a=t.date;return e[a]||(e[a]={}),e[a].cost?e[a].cost+=t.cost:e[a].cost=t.cost,e[a].date=t.date,e}),{});return Object.values(t)}(function(e){const t=["январь","февраль","март","апрель","май","июнь","июль","август","сентябрь","октябрь","ноябрь","декабрь"];return e.map((e=>{const a=e.date.split("-"),n=t[parseInt(a[1])-1],r=a[0];return{...e,date:`${n}, ${r}`}}))}(b(e,"increase")));u=function(e){let t=[];for(let a of e)a.cost>=0?t.push({...a,bg:{fill:"#31a51f"},bulletLocation:{centerY:am5.p100}}):t.push({...a,bg:{fill:"red"},bulletLocation:{centerY:am5.p0}});return t}((r=function(){const e=new Date,t=e.getMonth(),a=e.getFullYear();let n=[];for(let e=0;e<12;e++){let r=t-e,o=a;r<0&&(r+=12,o-=1);const s=new Date(o,r,1).toLocaleString("ru",{month:"long"});n.push(`${s}, ${o}`)}return n.map((e=>({cost:0,date:e})))}(),o=s,r.concat(o).reduce(((e,t)=>{const a=e.findIndex((e=>e.date===t.date));return-1===a?e.push(t):e[a].cost+=t.cost,e}),[]).reverse())),t.data.setAll(u),a.data.setAll(u),a.appear(),n.appear(1e3,100)}function v(e,t,a,n,r){d=q(S(e),r),t.data.setAll(L(q(S(e),r))),a.data.setAll(L(q(S(e),r))),a.appear(1e3),n.appear(1e3,100);let o=b(d,"decrease")[0].date,s=d.find((e=>e.date==o)).cost,l=b(d,"increase")[0].cost,c=b(d,"increase")[0].date,i=Math.floor((new Date(o).getTime()-new Date(c).getTime())/864e5);document.querySelector(".balance-dynamics-chart__total-num").textContent=s,document.querySelector(".balance-dynamics-chart__percent").textContent=C(l,s),document.querySelector(".balance-dynamics-chart__percent-name").textContent=M(i)}function w(e){return fetch(`https://database-fc7b1-default-rtdb.europe-west1.firebasedatabase.app/users/${g}/${e}.json`)}function b(e,t){return"decrease"==t?e.sort(((e,t)=>new Date(t.date)-new Date(e.date))):"increase"==t?e.sort(((e,t)=>new Date(e.date)-new Date(t.date))):void 0}function A(e){let t=[];for(let a of e)t.push({...a,cost:Math.abs(a.cost)});return t}function D(){let e=document.querySelector(".select-time").querySelector(".select__input-hidden").value,t=u.slice(u.length-+e),a=function(e){let t=e.reduce(((e,t)=>e+t.cost),0);return`${Math.floor(t/e.length)}`}(t),n=(c=t[0].cost,i=t[t.length-1].cost,c>=i?Math.floor(c/i*100-100)+"%":c<i?Math.abs(Math.floor(i/c*100-100))+"%":void 0),r=function(e,t,a){return e>=t?Math.floor((e/t*100-100)/a.length)+"%":e<t?Math.abs(Math.floor((t/e*100-100)/a.length))+"%":void 0}(t[0].cost,t[t.length-1].cost,t),o=document.querySelector(".trend-card__value_average"),s=document.querySelector(".trend-card__value_whole-difference"),l=document.querySelector(".trend-card__value_month-difference");var c,i;function d(e,t){"Infinity%"==e||"-Infinity%"==e||"NaN%"==e?(t.textContent="Н/д",t.style.color="black"):("0"==e?t.style.color="black":e.includes("-")?t.style.color="red":e.includes("-")||(t.style.color="#31a51f"),t.textContent=e)}d(a,o),d(n,s),d(r,l)}function S(e){let t=[...function(e){const t=[],a=new Date;for(let e=0;e<24;e++){const n=new Date(a.getTime());n.setMonth(a.getMonth()-e);const r=new Date(n.getFullYear(),n.getMonth()+1,0).getDate();for(let e=0;e<r;e++){let a;n.getMonth(),(new Date).getMonth(),a=new Date(n.getFullYear(),n.getMonth(),e+1);const r=new Date(a).toLocaleString("ru",{month:"numeric",day:"numeric",year:"numeric"});t.push(r.split(".").reverse().join("-"))}}return b(t.map((e=>({cost:0,date:e}))),"decrease")}().map((t=>{for(let a of e)a.date==t.date&&(t.cost+=a.cost);return t}))].reverse();return function(e){let a=0;for(let n=0;n<e.length;n++)0===e[n].cost?e[n].cost=a:(e[n-1]&&(e[n].cost=t[n-1].cost+e[n].cost),a=e[n].cost);return e}(t)}function L(e){for(let t of e)t.date=Date.parse(t.date);return e}function C(e,t){return 0==e||0==t?"Н/д":e>=t&&e<=0?-Math.floor(t/e*100-100)+"%":e>=t?Math.floor(t/e*100-100)+"%":e<t?Math.abs(Math.floor(t/e*100-100))+"%":void 0}function M(e){return 1==e||(e-11)%10==0&&11!=e?`за ${e} день`:2==e||3==e||4==e?`за ${e} дня`:`за ${e} дней`}function q(e,t){const a=new Date(e[e.length-1].date).getMonth()-t,n=new Date(new Date(e[e.length-1].date).getFullYear(),a,new Date(e[e.length-1].date).getDate()).toLocaleString("ru",{year:"numeric",month:"numeric",day:"numeric"}).split(".").reverse().join("-");return e.filter((e=>new Date(e.date)>=new Date(n)))}Promise.all([w("categoriesExpenses"),w("categoriesExpensesByDate"),w("categoriesIncome"),w("categoriesIncomeByDate"),w("operationsExpenses"),w("operationsExpensesByDate"),w("operationsIncome"),w("operationsIncomeByDate")]).then((e=>Promise.all([e[0].json(),e[1].json(),e[2].json(),e[3].json(),e[4].json(),e[5].json(),e[6].json(),e[7].json()]))).then((u=>{n=u[0]?u[0]:[],t=u[1]?u[1]:[],l=u[2]?u[2]:[],o=u[3]?u[3]:[],e=u[4]?u[4]:[],a=null!=u[5]?u[5]:[],r=u[6]?u[6]:[],s=null!=u[7]?u[7]:[],c=e&&r?e.concat(r):[],i=n&&l?n.concat(l):[],_(A(e),f.xAxis,f.series,f.chart),D(),function(e){var t=am5.Root.new("balance-dynamics-chart");t.setThemes([am5themes_Animated.new(t)]);var a=t.container.children.push(am5xy.XYChart.new(t,{panX:!1,panY:!1,paddingLeft:0}));a.zoomOutButton.set("forceHidden",!0);var n=am5xy.AxisRendererX.new(t,{minGridDistance:250}),r=a.xAxes.push(am5xy.DateAxis.new(t,{baseInterval:{timeUnit:"day",count:0},renderer:n})),o=am5xy.AxisRendererY.new(t,{}),s=a.yAxes.push(am5xy.ValueAxis.new(t,{renderer:o})),l=a.series.push(am5xy.LineSeries.new(t,{name:"Series",xAxis:r,yAxis:s,valueYField:"cost",valueXField:"date",tooltip:am5.Tooltip.new(t,{labelText:"{valueY}"}),stroke:"rgb(0,128,0)"}));l.fills.template.setAll({visible:!0,fillOpacity:.3}),l.set("fill","rgba(0,128,0, 0.3)");var c=s.makeDataItem({value:0,endValue:-1e7});s.createAxisRange(c);var i=s.makeDataItem({value:0,endValue:-1e5}),u=l.createAxisRange(i);u.fills.template.setAll({visible:!0,opacity:.3}),u.fills.template.set("fill","rgba(255, 0, 0, 0.6)"),u.strokes.template.set("stroke","rgba(255, 0, 0, 1)");var d=new Date;am5.time.add(d,"day",Math.round(l.dataItems.length/2));var m=d.getTime(),p=r.createAxisRange(r.makeDataItem({}));p.set("value",m),p.get("grid").setAll({strokeOpacity:1,stroke:"rgb(195, 195, 208)",strokeWidth:2});var h=am5.Button.new(t,{height:6,width:18,themeTags:["resize","horizontal"]});h.get("background").setAll({cornerRadiusTL:am5.p100,cornerRadiusTR:am5.p100,cornerRadiusBR:am5.p100,cornerRadiusBL:am5.p100,fill:"rgb(195, 195, 208)",fillOpacity:1,stroke:"rgb(195, 195, 208)"}),h.get("background").states.create("down",{}).setAll({fill:"rgb(195, 195, 208)",fillOpacity:1}),h.adapters.add("y",(function(){return 0}));let g=0;h.adapters.add("x",(function(e){return g=Math.max(0,Math.min(a.plotContainer.width(),e)),y.style.left=g+"px",g})),h.events.on("dragged",(function(){var t=h.x(),n=r.toAxisPosition(t/a.plotContainer.width()),o=r.positionToValue(n);p.set("value",o);let s=new Date(o).toLocaleString("ru",{year:"numeric",month:"numeric",day:"numeric"}).split(".").reverse().join("-"),l=e.find((e=>e.date==s)).cost,c=e[0].cost,i=e[0].date,u=Math.floor((new Date(s).getTime()-new Date(i).getTime())/864e5);document.querySelector(".balance-dynamics-chart__total-num").textContent=l,document.querySelector(".balance-dynamics-chart__percent").textContent=C(c,l),document.querySelector(".balance-dynamics-chart__percent-name").textContent=M(u),y.textContent=s,y.style.left=t+10+"px"})),p.set("bullet",am5xy.AxisBullet.new(t,{location:0,sprite:h})),x={chart:a,series:l,xAxis:r,yAxis:s,resizeButton1:h,range1:p}}(b(q(S(c),12),"increase")),v(c,x.xAxis,x.series,x.chart,12)})),document.querySelectorAll(".select").forEach((function(t){const a=t.querySelector(".select__button"),n=t.querySelector(".select__dropdown"),o=t.querySelector(".select__dropdown-list"),s=t.querySelectorAll(".select__dropdown-item"),l=t.querySelector(".select__input-hidden");a.addEventListener("click",(function(){o.classList.toggle("select__dropdown-list_visible"),n.classList.toggle("select__dropdown_visible"),this.classList.add("select__button_active")})),s.forEach((t=>{t.addEventListener("click",(function(s){if(s.stopPropagation(),a.querySelector(".select__button-title").textContent=this.textContent,l.value=this.dataset.value,o.classList.remove("select__dropdown-list_visible"),n.classList.remove("select__dropdown_visible"),t.closest(".select-trend")&&("expenses"==l.value?_(A(e),f.xAxis,f.series,f.chart):"income"==l.value?_(r,f.xAxis,f.series,f.chart):"netIncome"==l.value&&_(c,f.xAxis,f.series,f.chart)),D(),t.closest(".select-time-balance")){let e=b(q(S(c),+l.value),"increase");v(c,x.xAxis,x.series,x.chart,+l.value),x.range1.set("value",(new Date).getTime()),y.textContent=(new Date).toLocaleString("ru",{year:"numeric",month:"numeric",day:"numeric"}).split(".").reverse().join("-"),x.resizeButton1.events.on("dragged",(function(){var t=x.resizeButton1.x(),a=x.xAxis.toAxisPosition(t/x.chart.plotContainer.width()),n=x.xAxis.positionToValue(a);x.range1.set("value",n);let r=new Date(n).toLocaleString("ru",{year:"numeric",month:"numeric",day:"numeric"}).split(".").reverse().join("-"),o=e.find((e=>e.date==r))?e.find((e=>e.date==r)).cost:0,s=e[0].cost,l=e[0].date,c=Math.floor((new Date(r).getTime()-new Date(l).getTime())/864e5);document.querySelector(".balance-dynamics-chart__total-num").textContent=o,document.querySelector(".balance-dynamics-chart__percent").textContent=C(s,o),document.querySelector(".balance-dynamics-chart__percent-name").textContent=M(c),y.textContent=r,y.style.left=t+10+"px"}))}}))})),document.addEventListener("click",(function(e){e.target!=a&&(o.classList.remove("select__dropdown-list_visible"),n.classList.remove("select__dropdown_visible"))}))})),document.querySelectorAll(".statistics-types__item").forEach((e=>{e.addEventListener("click",(function(){let t=document.querySelector(".statistics-types__item_act");t&&t!=e&&t.classList.remove("statistics-types__item_act"),e.classList.add("statistics-types__item_act");let a=e.dataset.tab,n=document.getElementById(a),r=document.querySelector(".statistics-tabs__tab_act");r&&r!=n&&r.classList.remove("statistics-tabs__tab_act"),n.classList.add("statistics-tabs__tab_act"),x.series.appear(),x.chart.appear(1e3,100),f.series.appear(),f.chart.appear(1e3,100)}))}))})();