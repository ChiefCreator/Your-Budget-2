(()=>{"use strict";let e=[],t=null,a=null,n=[],o=[],r=null,l=null,s=[],c=[],i=null,u=[],d=[],m=document.querySelector(".main-date__value"),p=(new Date).getFullYear()+"-"+("0"+(+(new Date).getMonth()+1)).slice(-2);var h;localStorage.getItem("currentDate")||localStorage.setItem("currentDate",p),m.textContent=(h=localStorage.getItem("currentDate"))?"Все время"==h?h:7==h.length?new Date(h).toLocaleString("default",{month:"long"})+" "+new Date(h).getFullYear():4==h.length?h:void 0:(new Date).toLocaleString("default",{month:"long"})+" "+(new Date).getFullYear();let g=localStorage.getItem("email").replace(".","*");var f=am5.Root.new("trend-chart");f.setThemes([am5themes_Animated.new(f)]);var y=f.container.children.push(am5xy.XYChart.new(f,{panX:!0,wheelX:"panX",wheelY:"zoomX",pinchZoomX:!0,paddingLeft:0,layout:f.verticalLayout}));y.set("cursor",am5xy.XYCursor.new(f,{behavior:"none"})).lineY.set("visible",!1),y.zoomOutButton.set("forceHidden",!0);var v=am5xy.AxisRendererX.new(f,{pan:"zoom",minGridDistance:10}),x=y.xAxes.push(am5xy.CategoryAxis.new(f,{maxDeviation:.1,categoryField:"date",start:.5,minZoomCount:1,maxZoomCount:6,renderer:v}));x.get("renderer").labels.template.setAll({oversizedBehavior:"wrap",textAlign:"center"}),v.labels.template.setAll({fontSize:"0.8em"});var w=y.yAxes.push(am5xy.ValueAxis.new(f,{renderer:am5xy.AxisRendererY.new(f,{strokeOpacity:.1})})),_=y.series.push(am5xy.ColumnSeries.new(f,{name:"месяцы",xAxis:x,yAxis:w,valueYField:"cost",categoryXField:"date",fill:"rgb(0,128,0)"}));_.columns.template.setAll({tooltipText:"{categoryX}: {valueY}",width:am5.percent(90),tooltipY:0,strokeOpacity:0}),_.columns.template.setAll({templateField:"bg"}),_.bullets.push((function(){return am5.Bullet.new(f,{locationY:1,sprite:am5.Label.new(f,{text:"{valueY}",templateField:"bulletLocation",fill:"black",centerX:am5.percent(50),populateText:!0})})}));let b={};function A(e,t,a,n){var o,r,l=function(e){const t=e.reduce(((e,t)=>{const a=t.date;return e[a]||(e[a]={}),e[a].cost?e[a].cost+=t.cost:e[a].cost=t.cost,e[a].date=t.date,e}),{});return Object.values(t)}(function(e){const t=["январь","февраль","март","апрель","май","июнь","июль","август","сентябрь","октябрь","ноябрь","декабрь"];return e.map((e=>{const a=e.date.split("-"),n=t[parseInt(a[1])-1],o=a[0];return{...e,date:`${n}, ${o}`}}))}(S(e,"increase")));u=function(e){let t=[];for(let a of e)a.cost>=0?t.push({...a,bg:{fill:"#31a51f"},bulletLocation:{centerY:am5.p100}}):t.push({...a,bg:{fill:"red"},bulletLocation:{centerY:am5.p0}});return t}((o=function(){const e=new Date,t=e.getMonth(),a=e.getFullYear();let n=[];for(let e=0;e<12;e++){let o=t-e,r=a;o<0&&(o+=12,r-=1);const l=new Date(r,o,1).toLocaleString("ru",{month:"long"});n.push(`${l}, ${r}`)}return n.map((e=>({cost:0,date:e})))}(),r=l,o.concat(r).reduce(((e,t)=>{const a=e.findIndex((e=>e.date===t.date));return-1===a?e.push(t):e[a].cost+=t.cost,e}),[]).reverse())),t.data.setAll(u),a.data.setAll(u),a.appear(),n.appear(1e3,100)}function D(e){return fetch(`https://database-fc7b1-default-rtdb.europe-west1.firebasedatabase.app/users/${g}/${e}.json`)}function S(e,t){return"decrease"==t?e.sort(((e,t)=>new Date(t.date)-new Date(e.date))):"increase"==t?e.sort(((e,t)=>new Date(e.date)-new Date(t.date))):void 0}function C(e){let t=[];for(let a of e)t.push({...a,cost:Math.abs(a.cost)});return t}function L(){let e=document.querySelector(".select-time").querySelector(".select__input-hidden").value,t=u.slice(u.length-+e),a=function(e){let t=e.reduce(((e,t)=>e+t.cost),0);return`${Math.floor(t/e.length)}`}(t),n=(c=t[0].cost,i=t[t.length-1].cost,c>=i?Math.floor(c/i*100-100)+"%":c<i?Math.abs(Math.floor(i/c*100-100))+"%":void 0),o=function(e,t,a){return e>=t?Math.floor((e/t*100-100)/a.length)+"%":e<t?Math.abs(Math.floor((t/e*100-100)/a.length))+"%":void 0}(t[0].cost,t[t.length-1].cost,t),r=document.querySelector(".trend-card__value_average"),l=document.querySelector(".trend-card__value_whole-difference"),s=document.querySelector(".trend-card__value_month-difference");var c,i;function d(e,t){"Infinity%"==e||"-Infinity%"==e?(t.textContent="Н/д",t.style.color="black"):(e.includes("-")&&(t.style.color="red"),e.includes("-")||(t.style.color="#31a51f"),t.textContent=e)}d(a,r),d(n,l),d(o,s)}function Y(e){const t=[],a=new Date;for(let n=0;n<e;n++){const e=new Date(a.getTime());e.setMonth(a.getMonth()-n);const o=new Date(e.getFullYear(),e.getMonth()+1,0).getDate();for(let a=0;a<o;a++){const n=new Date(e.getFullYear(),e.getMonth(),a+1),o=new Date(n).toLocaleString("ru",{month:"numeric",day:"numeric",year:"numeric"});t.push(o.split(".").reverse().join("-"))}}return S(t.map((e=>({cost:0,date:e}))),"decrease")}function q(e,t){return function(e){let t=null;for(let a=e.length-1;a>=0;a--)0===e[a].cost?null!==t&&(e[a].cost=t):t=e[a].cost;return e}(t.map((t=>{for(let a of e)a.date==t.date&&(t.cost+=a.cost);return t})))}function M(e){for(let t of e)t.date=Date.parse(t.date);return e}function k(e,t){return 0==e||0==t?"Н/д":e>=t?Math.floor(t/e*100-100)+"%":e<t?Math.abs(Math.floor(t/e*100-100))+"%":void 0}function T(e){return 1==e||(e-11)%10==0&&11!=e?`за ${e} день`:2==e||3==e||4==e?`за ${e} дня`:`за ${e} дней`}!function(){var e=am5.Root.new("balance-dynamics-chart");e.setThemes([am5themes_Animated.new(e)]);var t=e.container.children.push(am5xy.XYChart.new(e,{panX:!0,panY:!1,wheelX:"panX",wheelY:"zoomX",paddingLeft:0}));t.set("cursor",am5xy.XYCursor.new(e,{behavior:"none"})).lineY.set("visible",!1),t.zoomOutButton.set("forceHidden",!0);var a=am5xy.AxisRendererX.new(e,{minGridDistance:250}),n=t.xAxes.push(am5xy.DateAxis.new(e,{baseInterval:{timeUnit:"day",count:1},renderer:a})),o=am5xy.AxisRendererY.new(e,{}),r=t.yAxes.push(am5xy.ValueAxis.new(e,{renderer:o})),l=t.series.push(am5xy.LineSeries.new(e,{name:"Series",xAxis:n,yAxis:r,valueYField:"cost",valueXField:"date",tooltip:am5.Tooltip.new(e,{labelText:"{valueY}"}),stroke:"rgb(0,128,0)"}));l.fills.template.setAll({visible:!0,fillOpacity:.3}),l.set("fill","rgba(0,128,0, 0.3)");var s=r.makeDataItem({value:0,endValue:-1e7});r.createAxisRange(s);var i=r.makeDataItem({value:0,endValue:-1e5}),u=l.createAxisRange(i);u.fills.template.setAll({visible:!0,opacity:.3}),u.fills.template.set("fill","rgba(255, 0, 0, 0.6)"),u.strokes.template.set("stroke","rgba(255, 0, 0, 1)");var d=new Date;am5.time.add(d,"day",Math.round(l.dataItems.length/2));var m=d.getTime(),p=n.createAxisRange(n.makeDataItem({}));p.set("value",m),p.get("grid").setAll({strokeOpacity:1,stroke:"black"});var h=am5.Button.new(e,{height:12,width:12,themeTags:["resize","horizontal"]});h.get("background").setAll({cornerRadiusTL:am5.p100,cornerRadiusTR:am5.p100,cornerRadiusBR:am5.p100,cornerRadiusBL:am5.p100,fill:"black",fillOpacity:1,stroke:"black"}),h.get("background").states.create("down",{}).setAll({fill:"black",fillOpacity:1}),h.adapters.add("y",(function(){return 0})),h.adapters.add("x",(function(e){return Math.max(0,Math.min(t.plotContainer.width(),e))})),h.events.on("dragged",(function(){var e=h.x(),a=n.toAxisPosition(e/t.plotContainer.width()),o=n.positionToValue(a);p.set("value",o);let r=new Date(o).toLocaleString("ru",{year:"numeric",month:"numeric",day:"numeric"}).split(".").reverse().join("-"),l=q(c,Y(12)).find((e=>e.date==r)).cost,s=S(q(c,Y(12)),"increase")[0].cost,i=S(q(c,Y(12)),"increase")[0].date,u=Math.floor((new Date(r).getTime()-new Date(i).getTime())/864e5);document.querySelector(".balance-dynamics-chart__total-num").textContent=l,document.querySelector(".balance-dynamics-chart__percent").textContent=k(s,l),document.querySelector(".balance-dynamics-chart__percent-name").textContent=T(u)})),p.set("bullet",am5xy.AxisBullet.new(e,{location:0,sprite:h})),b.chart=t,b.series=l,b.xAxis=n,b.yAxis=r,b.resizeButton1=h,b.range1=p}(),Promise.all([D("categoriesExpenses"),D("categoriesExpensesByDate"),D("categoriesIncome"),D("categoriesIncomeByDate"),D("operationsExpenses"),D("operationsExpensesByDate"),D("operationsIncome"),D("operationsIncomeByDate")]).then((e=>Promise.all([e[0].json(),e[1].json(),e[2].json(),e[3].json(),e[4].json(),e[5].json(),e[6].json(),e[7].json()]))).then((u=>{n=u[0],t=u[1],s=u[2],r=u[3],e=u[4],a=null!=u[5]?u[5]:[],o=u[6],l=null!=u[7]?u[7]:[],c=e.concat(o),i=n.concat(s),A(C(e),x,_,y),L(),d=q(c,Y(12));let m=S(d,"decrease")[0].date,p=d.find((e=>e.date==m)).cost,h=S(d,"increase")[0].cost,g=S(d,"increase")[0].date,f=Math.floor((new Date(m).getTime()-new Date(g).getTime())/864e5);document.querySelector(".balance-dynamics-chart__total-num").textContent=p,document.querySelector(".balance-dynamics-chart__percent").textContent=k(h,p),document.querySelector(".balance-dynamics-chart__percent-name").textContent=T(f),b.xAxis.data.setAll(M(q(c,Y(12)))),b.series.data.setAll(M(q(c,Y(12)))),b.series.appear(1e3),b.chart.appear(1e3,100)})),document.querySelectorAll(".select").forEach((function(t){const a=t.querySelector(".select__button"),n=t.querySelector(".select__dropdown"),r=t.querySelector(".select__dropdown-list"),l=t.querySelectorAll(".select__dropdown-item"),s=t.querySelector(".select__input-hidden");a.addEventListener("click",(function(){r.classList.toggle("select__dropdown-list_visible"),n.classList.toggle("select__dropdown_visible"),this.classList.add("select__button_active")})),l.forEach((t=>{t.addEventListener("click",(function(l){if(l.stopPropagation(),a.querySelector(".select__button-title").textContent=this.textContent,s.value=this.dataset.value,r.classList.remove("select__dropdown-list_visible"),n.classList.remove("select__dropdown_visible"),t.closest(".select-trend")&&("expenses"==s.value?A(C(e),x,_,y):"income"==s.value?A(o,x,_,y):"netIncome"==s.value&&A(c,x,_,y)),L(),t.closest(".select-time-balance")){let e=S(q(c,Y(+s.value)),"decrease")[0].date,t=q(c,Y(+s.value)).find((t=>t.date==e)).cost,a=S(q(c,Y(+s.value)),"increase")[0].cost,n=S(q(c,Y(+s.value)),"increase")[0].date,o=Math.floor((new Date(e).getTime()-new Date(n).getTime())/864e5);document.querySelector(".balance-dynamics-chart__total-num").textContent=t,document.querySelector(".balance-dynamics-chart__percent").textContent=k(a,t),document.querySelector(".balance-dynamics-chart__percent-name").textContent=T(o),b.resizeButton1.events.on("dragged",(function(){var e=b.resizeButton1.x(),t=b.xAxis.toAxisPosition(e/b.chart.plotContainer.width()),a=b.xAxis.positionToValue(t);b.range1.set("value",a);let n=new Date(a).toLocaleString("ru",{year:"numeric",month:"numeric",day:"numeric"}).split(".").reverse().join("-"),o=q(c,Y(+s.value)).find((e=>e.date==n)).cost,r=S(q(c,Y(+s.value)),"increase")[0].cost,l=S(q(c,Y(+s.value)),"increase")[0].date,i=Math.floor((new Date(n).getTime()-new Date(l).getTime())/864e5);document.querySelector(".balance-dynamics-chart__total-num").textContent=o,document.querySelector(".balance-dynamics-chart__percent").textContent=k(r,o),document.querySelector(".balance-dynamics-chart__percent-name").textContent=T(i)})),b.xAxis.data.setAll(M(q(c,Y(+s.value)))),b.series.data.setAll(M(q(c,Y(+s.value)))),b.range1.set("value",(new Date).getTime()),b.series.appear(1e3),b.chart.appear(1e3,100)}}))})),document.addEventListener("click",(function(e){e.target!=a&&(r.classList.remove("select__dropdown-list_visible"),n.classList.remove("select__dropdown_visible"))}))}))})();